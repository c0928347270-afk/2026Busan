<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 é‡œå±±äº”æ—¥éŠå°ˆæ¥­è¦åŠƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#E6F8F6', // æ·ºè‰²èƒŒæ™¯
                            DEFAULT: '#00A389', // å°ˆæ¥­è—ç¶ è‰²
                            dark: '#007A66',
                        },
                        text: '#2D3748', // æ·±ç°æ–‡å­—
                        background: '#F8F9FA', // æ·ºè‰²èƒŒæ™¯
                        card: '#FFFFFF', // å¡ç‰‡ç™½è‰²
                        accent: {
                            food: '#EF4444',     // Red for Food
                            shopping: '#3B82F6', // Blue for Shopping
                            sightseeing: '#10B981', // Green for Sightseeing
                            travel: '#F59E0B',   // Yellow for Travel
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'custom-sm': '0 1px 3px 0 rgba(0, 0, 0, 0.05)',
                        'custom-md': '0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.04)',
                        'custom-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8F9FA;
            color: #2D3748;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Card Style */
        .app-card {
            background-color: #FFFFFF; 
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Soft, professional shadow */
            border: 1px solid #E2E8F0;
        }

        /* Scrollbar Hide for Tabs */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* General Button Press Effect */
        .btn-press:active {
            transform: scale(0.98);
            box-shadow: none !important;
        }

        /* Mobile Bottom Nav Bar */
        @media (max-width: 1023px) {
            .mobile-nav-bar {
                background-color: #FFFFFF;
                box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.03);
            }
        }

        /* Desktop Layout */
        @media (min-width: 1024px) {
            #app-container {
                display: grid;
                grid-template-columns: 280px 1fr; /* Fixed left sidebar, flexible content */
                min-height: 100vh;
            }
            .main-content {
                padding: 32px 40px;
            }
            .sidebar {
                border-right: 1px solid #E2E8F0;
                background-color: #FFFFFF;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.02);
            }
        }
        
        /* Pie Chart CSS using conic-gradient for modern look */
        .pie-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(v-bind(pieChartBackground));
            box-shadow: 0 0 0 6px #fff, 0 0 0 7px #E2E8F0;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen">
    <div id="app-container" class="lg:grid">

        <aside class="sidebar fixed top-0 left-0 h-full w-72 p-6 lg:block hidden">
            <header class="mb-8">
                <h1 class="text-2xl font-black text-primary flex items-center gap-2">
                    <i class="ph ph-calendar-check text-3xl" weight="fill"></i>
                    BUSAN 2026
                </h1>
                <p class="text-sm text-text/60 font-medium mt-1">å°ˆæ¥­è¡Œç¨‹è¦åŠƒå·¥å…·</p>
            </header>
            
            <nav class="space-y-1">
                <button v-for="tab in desktopTabs" :key="tab.id"
                    @click="currentTab = tab.id"
                    :class="currentTab === tab.id ? 'bg-primary/10 text-primary font-bold' : 'text-text/80 hover:bg-background'"
                    class="w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors text-base btn-press">
                    <i :class="tab.icon" class="text-xl" :weight="currentTab === tab.id ? 'fill' : 'regular'"></i>
                    {{ tab.name }}
                </button>
            </nav>

            <div class="absolute bottom-6 left-6 right-6 pt-4 border-t border-gray-100">
                 <div class="text-xs text-text/50">
                    <i class="ph ph-info-circle mr-1"></i>
                    è¡Œç¨‹æ—¥æœŸï¼š2026.01.21 - 01.25
                 </div>
            </div>
        </aside>

        <main class="main-content lg:col-start-2 lg:pb-8 pb-28 p-5">

            <header class="lg:hidden pb-4 pt-2 flex justify-between items-center">
                 <h1 class="text-2xl font-black text-primary flex items-center gap-2">
                    <i :class="currentTabIcon" class="text-2xl" weight="fill"></i>
                    {{ currentTabName }}
                </h1>
                <p class="text-sm text-text/60 font-medium mt-1">Busan Trip 2026</p>
            </header>
            
            <div v-if="currentTab === 'itinerary'" class="space-y-6">
                <div class="app-card p-3 overflow-x-auto no-scrollbar shadow-custom-sm">
                    <div class="flex space-x-3">
                        <button v-for="i in 5" :key="i" 
                            @click="activeDay = i"
                            :class="activeDay === i ? 'bg-primary text-white shadow-custom-md' : 'bg-background text-text/80 border border-gray-200 hover:bg-gray-100'"
                            class="flex-shrink-0 w-16 h-16 rounded-lg flex flex-col items-center justify-center transition-all duration-300 btn-press text-sm font-bold">
                            <span class="text-[10px] uppercase opacity-80">{{ getDayInfo(i).date.slice(3) }}</span> 
                            <span class="text-xl font-black leading-none mt-0.5">{{ getDayInfo(i).day.slice(1) }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center px-1 mb-2 border-b border-gray-200 pb-3">
                    <h2 class="text-xl font-bold text-text">{{ getDayInfo(activeDay).fullDay }} æ—¥ç¨‹</h2>
                    <div class="flex items-center gap-2 text-base font-bold bg-primary/10 px-3 py-1.5 rounded-full text-primary">
                        <span class="text-xl leading-none">{{ getWeatherIcon(simulatedWeather[activeDay].code) }}</span>
                        <span class="text-lg font-black">{{ simulatedWeather[activeDay].temp }}Â°C</span>
                    </div>
                </div>

                <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                    <button v-for="cat in filterCategories" :key="cat.key"
                        @click="activeCategory = cat.key"
                        :class="[
                            activeCategory === cat.key ? 'bg-primary text-white shadow-custom-md' : 'bg-white text-text/80 border border-gray-300 hover:bg-gray-100',
                            cat.key !== 'all' ? cat.color : ''
                        ]"
                        class="flex-shrink-0 px-4 py-2 rounded-full flex items-center gap-2 text-sm font-medium transition-colors btn-press">
                        <i :class="cat.icon" :weight="activeCategory === cat.key ? 'fill' : 'regular'"></i>
                        {{ cat.name }}
                    </button>
                </div>


                <div class="space-y-4 pt-2">
                    <div v-if="filteredItineraryByCat.length === 0" class="text-center py-10 text-text/40 app-card border-dashed">
                        <p>æœ¬æ—¥ç„¡ç¬¦åˆã€Œ{{ filterCategories.find(c => c.key === activeCategory)?.name }}ã€çš„è¡Œç¨‹ ğŸ“</p>
                    </div>

                    <div v-for="item in filteredItineraryByCat" :key="item.id" 
                        class="app-card p-4 flex gap-4 relative transition-all duration-200 hover:shadow-custom-lg border-l-4"
                        :class="{'border-primary/50': item.isFlight, 'border-primary/20': !item.isFlight}">
                        
                        <div class="flex flex-col items-center min-w-[60px] flex-shrink-0">
                            <span class="text-sm font-bold text-primary px-1 font-mono leading-tight">
                                {{ item.time }}
                            </span>
                            <div class="h-full w-px bg-gray-300 my-2"></div>
                        </div>

                        <div class="flex-1 pb-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-base text-text leading-tight pr-6">{{ item.title }}</h3>
                                <span v-if="item.category && item.category !== 'flight'" 
                                    :class="getCategoryColor(item.category)"
                                    class="text-xs font-bold px-2 py-0.5 rounded-full bg-opacity-10 whitespace-nowrap">
                                    {{ getCategoryName(item.category) }}
                                </span>
                            </div>
                            
                            <div class="mt-1 flex items-center text-xs text-text/60 font-medium">
                                <i :class="item.isFlight ? 'ph ph-airplane-tilt text-primary' : 'ph ph-map-pin text-text/40'" class="mr-1"></i>
                                <span class="truncate">{{ item.location }}</span>
                            </div>

                            <p v-if="item.desc" class="text-sm text-text/80 mt-2 p-3 bg-primary/5 rounded-lg border-l-2 border-primary/20 w-full whitespace-pre-wrap shadow-inner">
                               {{ item.desc }}
                            </p>

                            <a v-if="!item.isFlight" :href="getNaverMapLink(item.location)" target="_blank" 
                               class="mt-3 inline-flex items-center text-xs font-bold text-white bg-primary px-4 py-2 rounded-full shadow-custom-md hover:bg-primary-dark transition-colors btn-press">
                                <i class="ph ph-navigation-arrow text-sm"></i> Naver Map å°èˆª
                            </a>
                        </div>
                    </div>
                </div>
                
                <button @click="openModal(null)" class="fixed bottom-24 right-5 bg-primary text-white w-14 h-14 rounded-full shadow-custom-lg flex items-center justify-center text-2xl z-20 hover:scale-105 transition-transform btn-press lg:hidden">
                    <i class="ph ph-plus" weight="bold"></i>
                </button>
            </div>

            <div v-if="currentTab === 'money'" class="space-y-6">
                <div class="space-y-3">
                    <div class="flex justify-between items-center px-1">
                        <h3 class="font-bold text-xl text-text flex items-center gap-2"><i class="ph ph-calculator text-primary text-2xl" weight="fill"></i> åŒ¯ç‡è¨ˆç®—æ©Ÿ</h3>
                        <div class="flex items-center gap-2 app-card px-3 py-1 rounded-full shadow-custom-sm border-2 border-primary/20">
                            <span class="text-xs text-text/60">KRW/TWD åŒ¯ç‡</span>
                            <input v-model.number="exchangeRate" type="number" class="w-14 text-right font-black text-sm outline-none text-primary bg-transparent" min="0.01" step="0.01">
                        </div>
                    </div>
                    
                    <div class="app-card p-5 bg-primary/5 border-l-4 border-primary/30">
                        <div class="flex items-center border-b border-gray-300 pb-3">
                            <span class="font-bold w-16 text-sm text-text/80">KRW (â‚©)</span>
                            <input v-model.number="calcKRW" type="number" placeholder="0" class="w-full text-right text-3xl font-black outline-none bg-transparent text-text">
                        </div>
                        <div class="flex items-center pt-3">
                            <span class="font-bold w-16 text-sm text-text/80">TWD (NT$)</span>
                            <div class="w-full text-right text-3xl font-black text-primary">
                                {{ formatNumber(calculatedTWD) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex justify-between items-end px-1 border-t border-gray-200 pt-6">
                        <h3 class="font-bold text-xl text-text flex items-center gap-2"><i class="ph ph-receipt text-primary text-2xl" weight="fill"></i> æ”¯å‡ºè¨˜å¸³</h3>
                        <div class="text-right app-card px-3 py-1.5 rounded-lg shadow-custom-sm">
                            <p class="text-xs text-text/60">ç¸½æ”¯å‡º (TWD)</p>
                            <p class="font-black text-xl text-primary">NT$ {{ formatNumber(totalExpenseTWD) }}</p>
                        </div>
                    </div>

                    <div class="app-card p-4 border-l-4 border-primary/30 space-y-4">
                        <h4 class="font-bold text-sm text-text/80 flex items-center gap-2">
                            <i class="ph ph-pencil-simple text-primary text-lg"></i> æ–°å¢æ¶ˆè²»é …ç›®
                        </h4>
                        
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-calendar-blank"></i> æ—¥æœŸ</label>
                                <input type="date" v-model="newExpense.date" class="w-full bg-gray-50 p-2 rounded-lg text-xs outline-none border text-center shadow-custom-sm mt-1">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-tag"></i> é¡åˆ¥</label>
                                <select v-model="newExpense.category" class="w-full bg-gray-50 p-2 rounded-lg text-xs outline-none border shadow-custom-sm mt-1">
                                    <option value="" disabled>é¸æ“‡é¡åˆ¥</option>
                                    <option v-for="cat in filterCategories.filter(c => c.key !== 'all' && c.key !== 'flight')" :key="cat.key" :value="cat.key">
                                        {{ cat.name }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-notepad"></i> å“é …åç¨± (æ¶ˆè²»å…§å®¹)</label>
                            <input v-model="newExpense.item" placeholder="ä¾‹å¦‚ï¼šæµ·æ±é¾å®®å¯ºè¨ˆç¨‹è»Šè²»" class="w-full bg-white p-2.5 rounded-lg text-sm outline-none border shadow-custom-sm focus:border-primary mt-1">
                        </div>
                        
                        <div>
                            <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-currency-krw"></i> é‡‘é¡ (éŸ“å…ƒ)</label>
                            <div class="relative w-full">
                                <input v-model.number="newExpense.amount" type="number" placeholder="0" class="w-full bg-white p-2.5 pl-8 rounded-lg text-sm outline-none border shadow-custom-sm focus:border-primary mt-1">
                                <span class="absolute left-2 top-[13px] text-sm text-text/40 font-bold">â‚©</span>
                            </div>
                        </div>
                        
                        <div>
                            <button @click="addExpense" :disabled="!newExpense.item || !newExpense.amount || newExpense.amount <= 0 || !newExpense.category" class="w-full bg-primary text-white py-3 rounded-lg font-bold text-base shadow-custom-md transform hover:scale-[1.02] transition btn-press disabled:opacity-50 mt-2">
                                <i class="ph ph-plus-bold"></i> æ–°å¢æ¶ˆè²»ç´€éŒ„
                            </button>
                        </div>
                    </div>
                    
                    <div class="app-card p-5">
                        <h4 class="font-bold text-sm text-text/80 mb-4 border-b border-dashed pb-2 flex items-center gap-2">
                            <i class="ph ph-chart-pie text-primary text-lg"></i> æ”¯å‡ºé¡åˆ¥åˆ†ä½ˆ (åœ“é¤…åœ–)
                        </h4>
                        <div v-if="totalExpenseTWD > 0" class="flex flex-col md:flex-row items-center justify-center gap-6">
                            <div class="flex-shrink-0">
                                <div class="pie-chart"></div>
                            </div>
                            <div class="space-y-1.5 flex-1 w-full max-w-xs">
                                <div v-for="(item, key) in expenseBreakdownTWD" :key="key" 
                                     class="flex justify-between items-center text-sm"
                                     v-if="item.percentage > 0">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full flex-shrink-0" :style="{ backgroundColor: item.color }"></span>
                                        <span class="font-medium text-text/80">{{ item.name }}</span>
                                    </div>
                                    <span class="font-bold text-primary">{{ item.percentage }}%</span>
                                    <span class="text-xs text-text/60">NT${{ formatNumber(item.amount) }}</span>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center text-sm text-text/40 py-4">å°šç„¡æ”¯å‡ºç´€éŒ„å¯ç¹ªè£½åœ–è¡¨</div>
                    </div>


                    <div class="space-y-2 pb-8">
                        <div v-for="(exp, index) in expenses" :key="index" class="app-card p-3 flex justify-between items-center border-l-4" :class="`border-${exp.category}-300`">
                            <div class="flex flex-col flex-1 truncate pr-2">
                                <span class="text-sm font-bold text-text truncate">{{ exp.item }}</span>
                                <span class="text-[10px] text-text/60">{{ exp.date.slice(5) }} Â· {{ getCategoryName(exp.category) }}</span>
                            </div>
                            <div class="flex items-center gap-3 flex-shrink-0">
                                <div class="text-right">
                                    <p class="font-bold text-text/60 text-xs">â‚©{{ formatNumber(exp.amount) }}</p>
                                    <p class="text-sm font-black text-primary">NT$ {{ formatNumber(exchangeRate > 0 ? Math.round(exp.amount / exchangeRate) : 0) }}</p>
                                </div>
                                <button @click="removeExpense(index)" class="text-text/30 hover:text-red-500 p-1 btn-press"><i class="ph ph-x-circle text-lg"></i></button>
                            </div>
                        </div>
                        <div v-if="expenses.length === 0" class="text-center text-sm text-text/30 py-4">
                            é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„å–”
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'info'" class="space-y-6">
                <h3 class="font-bold text-xl text-text px-1 flex items-center gap-2 border-b border-gray-200 pb-3"><i class="ph ph-airplane-takeoff text-primary text-2xl" weight="fill"></i> èˆªç­è³‡è¨Š</h3>

                <div class="app-card p-5 relative overflow-hidden bg-primary/5 border-l-4 border-primary">
                    <div class="flex justify-between items-center mb-4 border-b border-dashed border-primary/30 pb-3">
                        <h2 class="text-lg font-bold text-text">å»ç¨‹ TPE â†’ PUS</h2>
                        <span class="text-2xl font-black text-primary font-mono">{{ flightInfo.departure.flightNo }}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Departure Time</span>
                            <span class="font-bold text-text">{{ flightInfo.departure.depTime }} (Jan 21, 2026)</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Boarding Time</span>
                            <span class="font-bold text-red-500">{{ flightInfo.departure.boardingTime }}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Terminal / Gate</span>
                            <span class="font-bold text-text">{{ flightInfo.departure.terminal }} / {{ flightInfo.departure.gate }}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Arrival Time (PUS)</span>
                            <span class="font-bold text-text">17:40</span>
                        </div>
                    </div>
                </div>
                
                <div class="app-card p-5 relative overflow-hidden bg-red-500/5 border-l-4 border-red-500">
                    <div class="flex justify-between items-center mb-4 border-b border-dashed border-red-500/30 pb-3">
                        <h2 class="text-lg font-bold text-text">å›ç¨‹ PUS â†’ TPE</h2>
                        <span class="text-2xl font-black text-red-500 font-mono">{{ flightInfo.return.flightNo }}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Departure Time</span>
                            <span class="font-bold text-text">{{ flightInfo.return.depTime }} (Jan 25, 2026)</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Boarding Time</span>
                            <span class="font-bold text-red-500">{{ flightInfo.return.boardingTime }}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Terminal / Gate</span>
                            <span class="font-bold text-text">{{ flightInfo.return.terminal }} / {{ flightInfo.return.gate }}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-text/60 uppercase">Arrival Time (TPE)</span>
                            <span class="font-bold text-text">20:25</span>
                        </div>
                    </div>
                </div>


                <h3 class="font-bold text-xl text-text pt-4 px-1 flex items-center gap-2 border-b border-gray-200 pb-3"><i class="ph ph-buildings text-primary text-2xl" weight="fill"></i> ä½å®¿è³‡è¨Š</h3>
                <div class="app-card p-5 border-2 border-primary/20">
                    <div class="flex items-center mb-3">
                        <i class="ph ph-bed text-2xl text-primary mr-2"></i>
                        <h2 class="text-lg font-bold text-text leading-tight">{{ hotelInfo.name }}</h2>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="text-xs text-text/60 font-bold uppercase block mb-1">åœ°å€ (Address)</label>
                        <p class="font-bold text-sm text-text select-all">{{ hotelInfo.address }}</p>
                    </div>
                    
                    <a :href="getNaverMapLink(hotelInfo.name)" target="_blank" class="w-full mt-4 py-3 bg-primary text-white font-bold rounded-lg shadow-custom-md hover:bg-primary-dark transition btn-press flex items-center justify-center gap-2 text-sm">
                        <i class="ph ph-navigation-arrow"></i> Naver Map å°èˆª
                    </a>
                </div>
            </div>

            <div v-if="currentTab === 'guide'" class="space-y-6">

                <div class="app-card p-5 space-y-5">
                    <div class="space-y-3">
                        <h3 class="font-bold text-xl text-text flex items-center gap-2 border-b border-gray-200 pb-2">
                            <i class="ph ph-suitcase-rolling text-primary text-2xl" weight="fill"></i> è¡Œææ¸…å–®
                            <span class="text-xs text-text/60">({{ luggageList.filter(i => i.checked).length }} / {{ luggageList.length }})</span>
                        </h3>
                        
                        <div class="flex gap-2 p-1 rounded-md bg-gray-50">
                            <input v-model="newLuggageItem" @keyup.enter="addLuggage" type="text" placeholder="æ–°å¢ç‰©å“..." class="flex-1 bg-white p-2.5 rounded-lg text-sm outline-none border focus:border-primary shadow-custom-sm">
                            <button @click="addLuggage" class="bg-primary text-white px-3 h-10 rounded-lg flex items-center justify-center btn-press shadow-custom-md text-sm font-bold whitespace-nowrap"><i class="ph ph-plus-bold mr-1"></i> æ–°å¢</button>
                        </div>

                        <div class="space-y-2">
                            <div v-for="(item, index) in luggageList" :key="`l-${index}`" class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-custom-sm transition" :class="{'opacity-70 bg-gray-50': item.checked}">
                                <input type="checkbox" v-model="item.checked" class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary cursor-pointer">
                                <span class="ml-3 flex-1 text-sm font-medium text-text" :class="{'line-through text-text/40': item.checked}">{{ item.text }}</span>
                                <button @click="removeLuggage(index)" class="text-text/20 hover:text-red-500 px-2 btn-press"><i class="ph ph-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 pt-4 border-t border-gray-200">
                        <h3 class="font-bold text-xl text-text flex items-center gap-2 border-b border-gray-200 pb-2">
                            <i class="ph ph-bag-simple text-red-500 text-2xl" weight="fill"></i> å¿…è²·æ¸…å–®
                            <span class="text-xs text-text/60">({{ mustBuyList.filter(i => i.checked).length }} / {{ mustBuyList.length }})</span>
                        </h3>
                        
                        <div class="flex gap-2 p-1 rounded-md bg-gray-50">
                            <input v-model="newMustBuyItem" @keyup.enter="addMustBuy" type="text" placeholder="æ–°å¢å“é …..." class="flex-1 bg-white p-2.5 rounded-lg text-sm outline-none border focus:border-red-500 shadow-custom-sm">
                            <button @click="addMustBuy" class="bg-red-500 text-white px-3 h-10 rounded-lg flex items-center justify-center btn-press shadow-custom-md text-sm font-bold whitespace-nowrap"><i class="ph ph-plus-bold mr-1"></i> æ–°å¢</button>
                        </div>

                        <div class="space-y-2">
                            <div v-for="(item, index) in mustBuyList" :key="`m-${index}`" class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-custom-sm transition" :class="{'opacity-70 bg-gray-50': item.checked}">
                                <input type="checkbox" v-model="item.checked" class="form-checkbox h-5 w-5 text-red-500 rounded border-gray-300 focus:ring-red-500 cursor-pointer">
                                <span class="ml-3 flex-1 text-sm font-medium text-text" :class="{'line-through text-text/40': item.checked}">{{ item.text }}</span>
                                <button @click="removeMustBuy(index)" class="text-text/20 hover:text-red-500 px-2 btn-press"><i class="ph ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-card p-5 border-l-4 border-red-500/50 bg-red-500/5">
                    <h3 class="font-bold text-xl text-text flex items-center gap-2 mb-4 border-b border-red-500/20 pb-2">
                        <i class="ph ph-phone-call text-red-500 text-2xl" weight="fill"></i> ç·Šæ€¥è¯çµ¡é›»è©±
                    </h3>
                    <div class="space-y-3">
                        <div v-for="contact in emergencyContacts" :key="contact.number" class="flex justify-between items-center bg-white p-3 rounded-lg border border-red-500/30 shadow-custom-sm">
                            <div class="flex flex-col">
                                <span class="font-bold text-text text-sm">{{ contact.name }}</span>
                                <span class="text-xs text-text/60">{{ contact.desc }}</span>
                            </div>
                            <a :href="`tel:${contact.number}`" class="bg-red-500 text-white px-4 py-2 rounded-full font-bold text-sm btn-press shadow-custom-md hover:bg-red-600">
                                æ’¥æ‰“ {{ contact.number }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'map'" class="h-[70vh] flex flex-col space-y-4">
                <div class="app-card p-4 shadow-custom-sm">
                    <input v-model="mapQuery" @keyup.enter="searchNaverMap" type="text" placeholder="è¼¸å…¥åœ°é»æœå°‹ (ä¾‹å¦‚ï¼šæµ·é›²å°)" class="w-full bg-gray-50 px-4 py-3 rounded-lg text-sm outline-none font-medium mb-3 focus:bg-white focus:ring-2 focus:ring-primary/50 transition border border-gray-200">
                    
                    <div class="flex gap-3">
                        <button @click="searchNaverMap" class="flex-1 bg-primary text-white py-3 rounded-lg font-bold text-sm shadow-custom-md btn-press flex items-center justify-center gap-2 hover:bg-primary-dark">
                            <i class="ph ph-navigation-arrow"></i> Naver Map
                        </button>
                        <button @click="searchGoogleMap" class="flex-1 bg-white text-text border border-gray-300 py-3 rounded-lg font-bold text-sm shadow-custom-sm btn-press flex items-center justify-center gap-2 hover:bg-gray-100">
                            <i class="ph ph-map-pin"></i> Google Map
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 rounded-lg overflow-hidden shadow-custom-lg relative bg-gray-100 border border-gray-200">
                    <iframe width="100%" height="100%" style="border:0" loading="lazy" 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d102716.27850871927!2d129.0838128!3d35.1584949!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3568e89f81216d8f%3A0x6a0c5c36af1c944d!2sBusan%2C%20South%20Korea!5e0!3m2!1sen!2stw!4v1703649600000!5m2!1sen!2stw" 
                        allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                    <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold text-text/80 shadow-md border border-gray-200">
                        åƒ…ä¾›æ¦‚è¦½ï¼Œå°èˆªè«‹ä½¿ç”¨ä¸Šæ–¹æŒ‰éˆ•
                    </div>
                </div>
            </div>
        </main>
    </div>

    <nav class="fixed bottom-0 w-full pb-safe pt-2 px-2 flex justify-between items-center mobile-nav-bar rounded-t-xl z-30 lg:hidden">
        <button v-for="tab in mobileTabs" :key="tab.id"
            @click="currentTab = tab.id"
            :class="currentTab === tab.id ? 'text-primary' : 'text-text/50'" 
            class="flex flex-col items-center p-2 flex-1 transition-all">
            <i :class="tab.icon" class="text-2xl" :weight="currentTab === tab.id ? 'fill' : 'regular'"></i>
            <span class="text-[10px] font-bold mt-1">{{ tab.name }}</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 bg-text/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="app-card w-full max-w-sm rounded-xl p-6 shadow-custom-lg scale-100 transition-transform border-l-4 border-primary">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-text">
                    {{ isEditMode ? 'ç·¨è¼¯è¡Œç¨‹ âœï¸' : 'æ–°å¢ç­†è¨˜ âœ¨' }}
                </h3>
                <button @click="showModal = false" class="bg-gray-100 w-8 h-8 rounded-full text-text/70 hover:bg-gray-200 btn-press"><i class="ph ph-x"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-clock"></i> æ™‚é–“</label>
                    <input v-model="modalForm.time" type="time" class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none border focus:border-primary">
                </div>
                <div>
                    <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-tag"></i> é¡åˆ¥</label>
                    <select v-model="modalForm.category" class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none border focus:border-primary">
                        <option value="" disabled>é¸æ“‡è¡Œç¨‹é¡åˆ¥</option>
                        <option v-for="cat in filterCategories.filter(c => c.key !== 'all' && c.key !== 'flight')" :key="cat.key" :value="cat.key">{{ cat.name }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-text-h"></i> æ¨™é¡Œ</label>
                    <input v-model="modalForm.title" type="text" placeholder="è¡Œç¨‹åç¨±" class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none border focus:border-primary">
                </div>
                <div>
                    <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-map-pin"></i> åœ°é» (åœ°åœ–æœå°‹ç”¨)</label>
                    <input v-model="modalForm.location" type="text" placeholder="è¼¸å…¥é—œéµå­—" class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none border focus:border-primary">
                </div>
                <div>
                    <label class="text-xs text-primary font-bold ml-1 flex items-center gap-1"><i class="ph ph-chats"></i> å‚™è¨»/äº¤é€šè³‡è¨Š</label>
                    <textarea v-model="modalForm.desc" rows="3" placeholder="ä¾‹å¦‚ï¼šäº¤é€šæ–¹å¼ã€ç‡Ÿæ¥­æ™‚é–“..." class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none border focus:border-primary resize-none"></textarea>
                </div>
            </div>
            <button @click="saveItem" :disabled="!modalForm.title || !modalForm.category" class="w-full mt-6 py-3.5 bg-primary text-white font-bold rounded-lg shadow-custom-md btn-press disabled:opacity-50">
                å„²å­˜ç­†è¨˜
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // --- State ---
            const currentTab = ref('itinerary');
            const activeDay = ref(1);
            const activeCategory = ref('all'); 
            const showModal = ref(false);
            const isEditMode = ref(false);
            const mapQuery = ref('');
            
            // Guide
            const luggageList = ref([]);
            const newLuggageItem = ref('');
            const mustBuyList = ref([]);
            const newMustBuyItem = ref('');
            
            // Calculator
            const calcKRW = ref('');
            const exchangeRate = ref(41.5); 
            
            // Expenses
            const expenses = ref([]);
            
            const newExpense = ref({ 
                date: new Date().toISOString().split('T')[0], 
                item: '', 
                amount: null, 
                category: '' 
            });

            // Modal Form
            const modalForm = ref({ id: null, time: '', title: '', location: '', desc: '', category: '' });

            // --- Fixed Data ---

            const desktopTabs = [
                { id: 'itinerary', name: 'è¡Œç¨‹è¦åŠƒ', icon: 'ph-notebook' },
                { id: 'money', name: 'åŒ¯ç‡èˆ‡è¨˜å¸³', icon: 'ph-currency-krw' },
                { id: 'info', name: 'æ©Ÿç¥¨èˆ‡ä½å®¿', icon: 'ph-ticket' },
                { id: 'guide', name: 'æº–å‚™æ¸…å–®', icon: 'ph-list-checks' },
                { id: 'map', name: 'åœ°åœ–æœå°‹', icon: 'ph-map-trifold' },
            ];
            
            const mobileTabs = [
                { id: 'itinerary', name: 'è¡Œç¨‹', icon: 'ph-notebook' },
                { id: 'money', name: 'è¨˜å¸³', icon: 'ph-currency-krw' },
                { id: 'info', name: 'è³‡è¨Š', icon: 'ph-ticket' },
                { id: 'guide', name: 'æ¸…å–®', icon: 'ph-list-checks' },
                { id: 'map', name: 'åœ°åœ–', icon: 'ph-map-trifold' },
            ];

            const currentTabName = computed(() => {
                const tab = desktopTabs.find(t => t.id === currentTab.value);
                return tab ? tab.name : 'è¦åŠƒç¸½è¦½';
            });
            
            // Icon for Mobile Header
            const currentTabIcon = computed(() => {
                const tab = desktopTabs.find(t => t.id === currentTab.value);
                return tab ? tab.icon : 'ph-map-pin-line';
            });
            
            // Trip Date Mapping (Jan 21 - Jan 25, 2026)
            const tripDates = {
                1: { date: '01/21', day: 'é€±ä¸‰', fullDay: '1æœˆ21æ—¥ (é€±ä¸‰)' },
                2: { date: '01/22', day: 'é€±å››', fullDay: '1æœˆ22æ—¥ (é€±å››)' },
                3: { date: '01/23', day: 'é€±äº”', fullDay: '1æœˆ23æ—¥ (é€±äº”)' },
                4: { date: '01/24', day: 'é€±å…­', fullDay: '1æœˆ24æ—¥ (é€±å…­)' },
                5: { date: '01/25', day: 'é€±æ—¥', fullDay: '1æœˆ25æ—¥ (é€±æ—¥)' },
            };

            // Simulated Daily Weather
            const simulatedWeather = ref({
                1: { code: 2, temp: 8, rain: 20 }, 
                2: { code: 0, temp: 12, rain: 0 }, 
                3: { code: 51, temp: 6, rain: 70 }, 
                4: { code: 1, temp: 10, rain: 10 }, 
                5: { code: 0, temp: 11, rain: 0 }, 
            });

            const filterCategories = [
                { key: 'all', name: 'æ‰€æœ‰é …ç›®', icon: 'ph-list-checks', color: 'text-text' , colorCode: '#E2E8F0'},
                { key: 'food', name: 'ç¾é£Ÿé¤é£²', icon: 'ph-fork-knife', color: 'text-accent-food', colorCode: '#EF4444' },
                { key: 'shopping', name: 'è³¼ç‰©æ¶ˆè²»', icon: 'ph-shopping-bag', color: 'text-accent-shopping', colorCode: '#3B82F6' },
                { key: 'sightseeing', name: 'æ™¯é»æ´»å‹•', icon: 'ph-mountain', color: 'text-accent-sightseeing', colorCode: '#10B981' },
                { key: 'travel', name: 'äº¤é€šç¥¨åˆ¸', icon: 'ph-train-simple', color: 'text-accent-travel', colorCode: '#F59E0B' },
                { key: 'flight', name: 'æ©Ÿç¥¨/ä½å®¿', icon: 'ph-airplane-takeoff', color: 'text-indigo-600', colorCode: '#4F46E5' }
            ];

            const defaultLuggage = [
                { text: 'è­·ç…§ / ç°½è­‰', checked: false },
                { text: 'éŸ“å¹£ç¾é‡‘ / ä¿¡ç”¨å¡', checked: false },
                { text: 'è½‰æ¥é ­ (éŸ“åœ‹åœ“å­”)', checked: false },
                { text: 'è¡Œå‹•é›»æº / å……é›»ç·š', checked: false },
                { text: 'ç‰™åˆ·ç‰™è† (éŸ“åœ‹ç’°ä¿ä¸æä¾›)', checked: false },
                { text: 'ä¿æš–è¡£ç‰© / åœå·¾', checked: false },
                { text: 'ç¶²å¡ / eSim', checked: false }
            ];

            const defaultMustBuy = [
                { text: 'Olive Young è­·è†šå“', checked: false },
                { text: 'é›¶é£Ÿ (çƒé¾œé¤…ä¹¾)', checked: false },
                { text: 'Kakao Friends å‘¨é‚Š', checked: false },
                { text: 'Market O å¸ƒæœ—å°¼', checked: false },
                { text: 'è¥ªå­', checked: false }
            ];

            const emergencyContacts = [
                { name: 'è­¦å¯Ÿå±€', number: '112', desc: 'Police' },
                { name: 'æ¶ˆé˜²/æ•‘è­·è»Š', number: '119', desc: 'Fire/Ambulance' },
                { name: 'æ—…éŠè«®è©¢ç†±ç·š', number: '1330', desc: 'Korea Travel Hotline' }
            ];

            // Itinerary Default Data 
            const defaultItinerary = [
                // --- Day 1 (Jan 21) ---
                { id: 100, day: 1, time: '09:00', title: 'å¾å®¶è£¡å‡ºç™¼', location: 'æ¡ƒåœ’', desc: 'å‰å¾€æ¡ƒåœ’æ©Ÿå ´ T2', isFlight: false, category: 'travel' },
                { id: 101, day: 1, time: '11:00', title: 'æŠµé”æ¡ƒåœ’æ©Ÿå ´ T2', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T2', desc: 'è¾¦ç†å ±åˆ°ã€æ‰˜é‹ã€å‡ºå¢ƒæµç¨‹ã€‚', isFlight: false, category: 'travel' },
                { id: 102, day: 1, time: '14:25', title: 'é•·æ¦®èˆªç©º BR180 (æ¡ƒåœ’â†’é‡œå±±) å•Ÿç¨‹', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T2', desc: 'é è¨ˆ 17:40 æŠµé”é‡œå±±é‡‘æµ·æ©Ÿå ´ (PUS)ã€‚', isFlight: true, category: 'flight', flightNo: 'BR180', depAirport: 'TPE', arrAirport: 'PUS', depTime: '14:25', terminal: 'T2', gate: 'TBD', boardingTime: '13:55', type: 'departure' },
                { id: 103, day: 1, time: '17:40', title: 'æŠµé”é‡œå±±é‡‘æµ·æ©Ÿå ´ (PUS)', location: 'Gimhae International Airport', desc: 'å…¥å¢ƒèˆ‡é ˜å–è¡Œæ (ç´„ 20-30 åˆ†é˜)ã€‚', isFlight: false, category: 'travel' },
                { id: 104, day: 1, time: '18:20', title: 'æ©Ÿå ´ $\rightarrow$ é£¯åº— (äº¤é€šè½‰ä¹˜)', location: 'é‡œå±±é‡‘æµ·æ©Ÿå ´', desc: 'è¼•è»Œï¼šé‡‘æµ·æ©Ÿå ´ç«™ $\rightarrow$ æ²™ä¸Šç«™ / åœ°éµï¼šæ²™ä¸Š $\rightarrow$ è¥¿é¢ $\rightarrow$ å—æµ¦ç«™ã€‚ç¸½äº¤é€šæ™‚é–“ç´„ 60 åˆ†é˜ã€‚', isFlight: false, category: 'travel' },
                { id: 105, day: 1, time: '19:00', title: 'é‡œå±±äºé›²æ¨¹é£¯åº— Check-in', location: 'Hotel Aventree Busan', desc: 'è¾¦ç†å…¥ä½æ‰‹çºŒã€‚', isFlight: false, category: 'flight' },
                { id: 106, day: 1, time: '20:00', title: 'æ™šé¤èˆ‡å¤œé–“è‡ªç”±æ´»å‹•', location: 'å—æµ¦æ´ (æ‰å˜å…¶å¸‚å ´/BIFF/å¯Œå¹³)', desc: 'æ™šé¤å»ºè­°ï¼šå—æµ¦è”˜é›æ¹¯ / å…ƒç¥–é‡œå±±è±¬è…³ã€‚', isFlight: false, category: 'food' },
                
                // --- Day 2 (Jan 22) ---
                { id: 201, day: 2, time: '08:00', title: 'å¾å—æµ¦æ´å‡ºç™¼ $\rightarrow$ æµ·é›²å°ç«™', location: 'æµ·é›²å°ç«™', desc: 'åœ°éµç´„ 50 åˆ†é˜ï¼Œè¨ˆç¨‹è»Šç´„ 25-30 åˆ†é˜ï¼ˆè‹¥æƒ³çœæ™‚é–“ï¼Œæ¨è–¦è¨ˆç¨‹è»Šï¼‰ã€‚', isFlight: false, category: 'travel' },
                { id: 202, day: 2, time: '09:00', title: 'æµ·é›²å°å‚³çµ±å¸‚å ´ (æ—©é¤)', location: 'í•´ìš´ëŒ€ ì „í†µì‹œì¥', desc: 'æ¨è–¦ï¼šæ‰‹å·¥é£¯æ²ã€æµ·é®®ç…é¤…ç­‰åœ¨åœ°ç¾é£Ÿã€‚åœç•™ç´„ 40 åˆ†é˜ã€‚', isFlight: false, category: 'food' },
                { id: 203, day: 2, time: '09:45', title: 'æµ·é›²å°æµ·é‚Šæ•£æ­¥', location: 'æµ·é›²å°æµ·é‚Š', desc: 'ç°¡å–®æ•£æ­¥ã€æ‹ç…§ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 204, day: 2, time: '10:00', title: 'å‰å¾€æµ·æ±é¾å®®å¯º', location: 'æµ·æ±é¾å®®å¯º', desc: 'äº¤é€šï¼šè¨ˆç¨‹è»Šè»Šç¨‹ç´„ 15-18 åˆ†é˜ï¼ˆæœ€çœæ™‚ï¼‰ã€‚', isFlight: false, category: 'travel' },
                { id: 205, day: 2, time: '10:20', title: 'æµ·æ±é¾å®®å¯º åƒè§€', location: 'í•´ë™ìš©ê¶ì‚¬', desc: 'åƒè§€ï¼šé¾é–€çŸ³æ©‹ã€è§€éŸ³åƒã€æµ·å²¸æ­¥é“ã€‚åœç•™ç´„ 1.2 å°æ™‚ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 206, day: 2, time: '11:40', title: 'æ¨‚å¤© Outlet (æ±é‡œå±±åº—)', location: 'ë¡¯ë°í”„ë¦¬ë¯¸ì—„ì•„ìš¸ë › ë™ë¶€ì‚°ì ', desc: 'å¯åœ¨æ­¤ç”¨é¤åŠè³¼ç‰© (å½ˆæ€§è¡Œç¨‹)ã€‚', isFlight: false, category: 'shopping' },
                { id: 207, day: 2, time: '14:10', title: 'æ–°ä¸–ç•Œç™¾è²¨ (Centum City)', location: 'ì‹ ì„¸ê³„ë°±í™”ì  ì„¼í…€ì‹œí‹°', desc: 'é€›è¡—ã€å°é»å¿ƒã€‚', isFlight: false, category: 'shopping' },
                { id: 208, day: 2, time: '15:00', title: 'SPA LAND æ±—è’¸å¹•', location: 'SPA LAND (æ–°ä¸–ç•Œç™¾è²¨ B1)', desc: 'ä¼‘æ¯æ”¾é¬†ï¼Œé«”é©—è¨­æ–½ã€‚åœç•™ç´„ 2 å°æ™‚ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 209, day: 2, time: '17:20', title: 'è¿”å›å—æµ¦æ´ (åœ°éµ)', location: 'å—æµ¦ç«™', desc: 'åœ°éµï¼šCentum City $\rightarrow$ è¥¿é¢ $\rightarrow$ å—æµ¦æ´ (ç´„ 45 åˆ†é˜)ã€‚', isFlight: false, category: 'travel' },
                { id: 210, day: 2, time: '18:10', title: 'å—æµ¦æ´æ™šé¤èˆ‡å¤œé–“é€›è¡—', location: 'å—æµ¦æ´ / è¥¿é¢åœ°ä¸‹è¡—', desc: 'æ™šé¤å»ºè­°ï¼šä¼ç­é•·ç‡’è‚‰ (æµ·é›²å°) / å—æµ¦æ´å‘¨é‚Šé¤å»³ã€‚', isFlight: false, category: 'food' },

                // --- Day 3 (Jan 23) ---
                { id: 301, day: 3, time: '09:00', title: 'KKday é‡œå±±ä¸€æ—¥éŠ é›†åˆå‡ºç™¼', location: 'é‡œå±±ç«™ 1 è™Ÿå‡ºå£', desc: 'äº¤é€šæ–¹å¼ï¼šä¸€æ—¥éŠå·´å£«ã€‚', isFlight: false, category: 'travel' },
                { id: 302, day: 3, time: '10:30', title: 'å¤©ç©ºè† å›Š (è—ç·šå…¬åœ’)', location: 'æµ·é‚Šåˆ—è»Š (ì²­ì‚¬í¬)', desc: 'é«”é©—æµ·å²¸è† å›Šåˆ—è»Šã€‚', isFlight: false, category: 'sightseeing' },
                { id: 303, day: 3, time: '13:10', title: 'æµ·æ±é¾å®®å¯º (æœ¬æ—¥ç¬¬äºŒæ¬¡é€ è¨ª)', location: 'í•´ë™ìš©ê¶ì‚¬', desc: 'KKday è¡Œç¨‹å®‰æ’ã€‚åˆé¤å»ºè­°ï¼šé“ç†™å®¶æµ·é®® (è¿‘é’æ²™æµ¦)ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 304, day: 3, time: '15:00', title: 'ä½›åœ‹å¯º (æ…¶å·ä¸–ç•Œéºç”¢)', location: 'ä½›åœ‹å¯º', desc: 'æ…¶å·ä¸–ç•Œéºç”¢ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 305, day: 3, time: '16:40', title: 'å¤§é™µé™¢ + çš‡ç†åœ˜è·¯', location: 'æ…¶å·å¤§é™µé™¢ / çš‡ç†åœ˜è·¯', desc: 'æ…¶å·æ­·å²æ–‡åŒ–å€æ•£ç­–ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 306, day: 3, time: '19:00', title: 'æ±å®®èˆ‡æœˆæ±  (é›é´¨æ± ) å¤œæ™¯', location: 'æ±å®®èˆ‡æœˆæ± ', desc: 'æ¬£è³æ…¶å·è‘—åå¤œæ™¯ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 307, day: 3, time: '21:50', title: 'ä¸€æ—¥éŠè¿”å›é‡œå±±ç«™', location: 'é‡œå±±ç«™', desc: 'å¯é¸æ“‡åœ¨è¥¿é¢ç«™æå‰ä¸‹è»Šï¼Œé€›è¥¿é¢å¤§å‰µ 2 è™Ÿåº—ã€‚', isFlight: false, category: 'travel' },

                // --- Day 4 (Jan 24) ---
                { id: 401, day: 4, time: '08:00', title: 'é£¯åº—å‡ºç™¼ / æ—©é¤', location: 'å—æµ¦æ´', desc: 'å¾é£¯åº—å‡ºç™¼ï¼Œæº–å‚™å‰å¾€æ¾å³¶ã€‚', isFlight: false, category: 'food' },
                { id: 402, day: 4, time: '09:30', title: 'æ¾å³¶å¤©ç©ºæ­¥é“', location: 'ì†¡ë„ìŠ¤ì¹´ì´ì›Œí¬', desc: 'äº¤é€šï¼šå¾æœ­å˜å…¶ç«™å«è»Šç´„ 5 åˆ†é˜æŠµé”ã€‚åœç•™ç´„ 20-30 åˆ†é˜ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 403, day: 4, time: '10:20', title: 'æ¾å³¶æµ·ä¸Šçºœè»Š (Air Cruise)', location: 'ì†¡ë„í•´ìƒì¼€ì´ë¸”ì¹´', desc: 'å»ºè­°æ­ä¹˜ä¾†å›ï¼Œè§€è³æµ·æ™¯ã€‚ç´„ 1 å°æ™‚ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 404, day: 4, time: '11:30', title: 'åˆé¤ (æ¨‚å¤©ç™¾è²¨å…‰å¾©åº—)', location: 'ë¡¯ë°ë°±í™”ì  ê´‘ë³µì ', desc: 'åœ¨ç™¾è²¨å…§ç”¨é¤ã€‚', isFlight: false, category: 'food' },
                { id: 405, day: 4, time: '13:20', title: 'æ¨‚å¤©ç™¾è²¨é ‚æ¨“ (æ˜Ÿå…‰èŠ±åœ’)', location: 'æ¨‚å¤©ç™¾è²¨å…‰å¾©åº—é ‚æ¨“', desc: 'ææ—©æŠµé”è§€æ™¯ä½ï¼Œæº–å‚™è§€è³é–‹æ©‹å„€å¼ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 406, day: 4, time: '14:00', title: 'è§€è³å½±å³¶å¤§æ©‹é–‹æ©‹å„€å¼', location: 'å½±å³¶å¤§æ©‹ (è§€è³é»)', desc: 'æº–æ™‚é–‹å§‹ï¼Œç´„ 5-7 åˆ†é˜ã€‚ç‚ºæœ€ä½³ä¿¯ç°è§’åº¦ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 407, day: 4, time: '15:00', title: 'ç™½æ·ºç˜æ–‡åŒ–æ‘', location: 'í°ì—¬ìš¸ë¬¸í™”ë§ˆì„', desc: 'äº¤é€šï¼šè¨ˆç¨‹è»Šå¾æ¨‚å¤©ç™¾è²¨æ­è»Šç´„ 10-12 åˆ†é˜ã€‚åœç•™ç´„ 40-60 åˆ†é˜ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 408, day: 4, time: '16:00', title: 'å¤ªå®—å°éŠåœ’åœ°', location: 'íƒœì¢…ëŒ€ìœ ì›ì§€', desc: 'éœ€æ­ä¹˜ã€Œä¸¹é’åˆ—è»Šã€éŠè¦½ç‡ˆå¡”ã€è§€æ™¯å°ã€‚åœç•™ç´„ 1.5 å°æ™‚ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 409, day: 4, time: '18:30', title: 'è¿”å›å—æµ¦æ´æ™šé¤', location: 'å—æµ¦æ´', desc: 'è»Šç¨‹ç´„ 20 åˆ†é˜ã€‚', isFlight: false, category: 'food' },
                { id: 410, day: 4, time: '20:00', title: 'é‡œå±±å¡”å¤œæ™¯', location: 'ë¶€ì‚°íƒ€ì›Œ/ìš©ë‘ì‚°ê³µì›', desc: 'æ­¥è¡Œ/æ‰‹æ‰¶æ¢¯è‡³é¾é ­å±±å…¬åœ’ï¼Œä¿¯ç°å—æµ¦å¤œæ™¯ã€‚åœç•™ç´„ 40-60 åˆ†é˜ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 411, day: 4, time: '21:00', title: 'å—æµ¦æ´è‡ªç”±é€›è¡— / BIFF å»£å ´', location: 'å—æµ¦æ´ / BIFF ê´‘ì¥', desc: 'å¤œé–“è‡ªç”±æ´»å‹•ã€‚', isFlight: false, category: 'shopping' },

                // --- Day 5 (Jan 25) ---
                { id: 501, day: 5, time: '08:00', title: 'æ—©é¤ + æ•´ç†è¡Œæ', location: 'é‡œå±±äºé›²æ¨¹é£¯åº—', desc: 'Check Out Timeï¼š11:00 AMï¼Œè¡Œæå¯„æ”¾æ«ƒæª¯ã€‚', isFlight: false, category: 'food' },
                { id: 502, day: 5, time: '09:00', title: 'é£¯åº—å‡ºç™¼ $\rightarrow$ ç”˜å·æ´æ–‡åŒ–æ‘', location: 'ç”˜å·æ´æ–‡åŒ–æ‘', desc: 'äº¤é€šï¼šè¨ˆç¨‹è»Šå¾å—æµ¦æ´æ­è»Šç´„ 10-15 åˆ†é˜ã€‚', isFlight: false, category: 'travel' },
                { id: 503, day: 5, time: '09:15', title: 'ç”˜å·æ´æ–‡åŒ–æ‘æ•£ç­–', location: 'ê°ì²œë¬¸í™”ë§ˆì„', desc: 'å»ºè­°åƒè§€ï¼šå°ç‹å­æ‹ç…§é»ã€è§€æ™¯å¹³å°ã€‚åœç•™ç´„ 2 å°æ™‚ã€‚', isFlight: false, category: 'sightseeing' },
                { id: 504, day: 5, time: '11:30', title: 'è¿”å›å—æµ¦æ´', location: 'å—æµ¦æ´', desc: 'äº¤é€šï¼šè¨ˆç¨‹è»Šè»Šç¨‹ç´„ 10-15 åˆ†é˜ã€‚', isFlight: false, category: 'travel' },
                { id: 505, day: 5, time: '11:45', title: 'åˆé¤ (å—æµ¦æ´)', location: 'å—æµ¦æ´', desc: 'å¯é¸æ“‡å…ƒç¥–è”˜é›æ¹¯ã€å¯Œå¹³å¸‚å ´å°åƒç­‰ã€‚', isFlight: false, category: 'food' },
                { id: 506, day: 5, time: '13:00', title: 'å—æµ¦æ´è‡ªç”±æ´»å‹•/è³¼ç‰©', location: 'å…‰å¾©è·¯è³¼ç‰©è¡—', desc: 'é€²è¡Œæœ€å¾Œçš„è³¼ç‰©è£œè²¨ã€‚', isFlight: false, category: 'shopping' },
                { id: 507, day: 5, time: '14:30', title: 'å›é£¯åº—é ˜è¡Œæ', location: 'é‡œå±±äºé›²æ¨¹é£¯åº—', desc: 'æª¢æŸ¥è­·ç…§ã€é€€ç¨…å–®ç­‰é‡è¦ç‰©å“ã€‚', isFlight: false, category: 'travel' },
                { id: 508, day: 5, time: '15:00', title: 'å—æµ¦æ´ $\rightarrow$ é‡‘æµ·æ©Ÿå ´', location: 'Gimhae International Airport', desc: 'äº¤é€šï¼šåœ°éµ $\rightarrow$ è¼•è»Œã€‚éœ€é ç•™è¶³å¤ æ™‚é–“ (å…¨ç¨‹ç´„ 60 åˆ†é˜)ã€‚', isFlight: false, category: 'travel' },
                { id: 509, day: 5, time: '16:00', title: 'æŠµé”é‡‘æµ·æ©Ÿå ´', location: 'Gimhae International Airport', desc: 'è¾¦ç†å ±åˆ°ã€æ‰˜é‹ã€KIOSK æƒæé€€ç¨…æ¢ç¢¼ã€‚', isFlight: false, category: 'travel' },
                { id: 510, day: 5, time: '17:20', title: 'å€™æ©Ÿ/å…ç¨…åº—è³¼ç‰©/é ˜é€€ç¨…é‡‘', location: 'Gimhae International Airport', desc: 'å‡ºå¢ƒå¾Œåˆ° 4 è™Ÿå€åŸŸçš„é€€ç¨…æ«ƒæª¯é ˜å–ç¾é‡‘ã€‚', isFlight: false, category: 'shopping' },
                { id: 511, day: 5, time: '18:55', title: 'å›ç¨‹: é•·æ¦®èˆªç©º BR163 (é‡œå±±â†’æ¡ƒåœ’) å•Ÿç¨‹', location: 'Gimhae International Airport', desc: 'é è¨ˆ 20:25 æŠµé”æ¡ƒåœ’æ©Ÿå ´ T2ã€‚', isFlight: true, category: 'flight', flightNo: 'BR163', depAirport: 'PUS', arrAirport: 'TPE', depTime: '18:55', terminal: 'Intl', gate: 'TBD', boardingTime: '18:25', type: 'return' },
                { id: 512, day: 5, time: '20:25', title: 'æŠµé”æ¡ƒåœ’æ©Ÿå ´', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T2', desc: 'æ—…è¡ŒçµæŸ', isFlight: false, category: 'travel' },
            ];


            const itinerary = ref([]);
            
            // --- Lifecycle ---
            onMounted(() => {
                newExpense.value.date = new Date().toISOString().split('T')[0];

                // Load from LocalStorage (Using v9.3 key)
                const savedItinerary = localStorage.getItem('busan_2026_v9_itinerary'); 
                // ã€ä¿®å¾©ï¼šçµ±ä¸€Expenseçš„å„²å­˜éµåä»¥ç¢ºä¿è¼‰å…¥ã€‘
                const savedExpenses = localStorage.getItem('busan_2026_v9_expenses');
                const savedRate = localStorage.getItem('busan_2026_rate_v9');
                const savedLuggage = localStorage.getItem('busan_2026_luggage_v9');
                const savedMustBuy = localStorage.getItem('busan_2026_mustbuy_v9');
                
                itinerary.value = savedItinerary ? JSON.parse(savedItinerary) : defaultItinerary;
                if (savedExpenses) expenses.value = JSON.parse(savedExpenses);
                if (savedRate && parseFloat(savedRate) > 0) {
                     exchangeRate.value = parseFloat(savedRate);
                } else {
                     exchangeRate.value = 41.5; 
                }
                luggageList.value = savedLuggage ? JSON.parse(savedLuggage) : defaultLuggage;
                mustBuyList.value = savedMustBuy ? JSON.parse(savedMustBuy) : defaultMustBuy;
            });

            // --- Watchers for Auto-Save ---
            watch([itinerary, expenses, exchangeRate, luggageList, mustBuyList], () => {
                localStorage.setItem('busan_2026_v9_itinerary', JSON.stringify(itinerary.value));
                localStorage.setItem('busan_2026_v9_expenses', JSON.stringify(expenses.value));
                localStorage.setItem('busan_2026_rate_v9', exchangeRate.value);
                localStorage.setItem('busan_2026_luggage_v9', JSON.stringify(luggageList.value));
                localStorage.setItem('busan_2026_mustbuy_v9', JSON.stringify(mustBuyList.value));
            }, { deep: true });

            // --- Computed ---

            // Step 1: Filter by Day
            const filteredItinerary = computed(() => {
                return itinerary.value
                    .filter(item => item.day === activeDay.value)
                    .sort((a, b) => a.time.localeCompare(b.time));
            });

            // Step 2: Filter by Category (if activeCategory is not 'all')
            const filteredItineraryByCat = computed(() => {
                if (activeCategory.value === 'all') {
                    return filteredItinerary.value;
                }
                return filteredItinerary.value.filter(item => item.category === activeCategory.value);
            });

            const totalExpenseTWD = computed(() => {
                const totalKRW = expenses.value.reduce((sum, item) => sum + item.amount, 0);
                const rate = Number(exchangeRate.value);
                // ã€ä¿®å¾©ï¼šæª¢æŸ¥åŒ¯ç‡æ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢é™¤ä»¥é›¶ã€‘
                if (rate <= 0 || isNaN(rate)) return 0;
                return Math.round(totalKRW / rate);
            });
            
            const calculatedTWD = computed(() => {
                const krw = Number(calcKRW.value) || 0;
                const rate = Number(exchangeRate.value); 
                
                // ã€ä¿®å¾©ï¼šæª¢æŸ¥åŒ¯ç‡æ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢é™¤ä»¥é›¶ã€‘
                if (rate <= 0 || isNaN(rate)) {
                    return 0; 
                }
                
                return Math.round(krw / rate);
            });

            // Expense Breakdown for Chart
            const expenseBreakdownTWD = computed(() => {
                const breakdown = {};
                const rate = Number(exchangeRate.value); 
                
                // ã€ä¿®å¾©ï¼šæª¢æŸ¥åŒ¯ç‡æ˜¯å¦æœ‰æ•ˆï¼Œç„¡æ•ˆå‰‡è·³éè¨ˆç®—ã€‘
                if (rate <= 0 || isNaN(rate)) return {}; 
                
                // 1. Calculate TWD per category
                expenses.value.forEach(exp => {
                    // Exclude 'flight' category from daily/general expense chart
                    if (exp.category === 'flight') return; 

                    // ç¢ºä¿é‡‘é¡æ˜¯æœ‰æ•ˆæ•¸å­—
                    const expAmount = Number(exp.amount);
                    if (isNaN(expAmount) || expAmount <= 0) return;

                    const twdAmount = Math.round(expAmount / rate);
                    if (breakdown[exp.category]) {
                        breakdown[exp.category].amount += twdAmount;
                    } else {
                        breakdown[exp.category] = { amount: twdAmount };
                    }
                });
                
                // 2. Add Name and Color
                const nonFlightCategories = filterCategories.filter(c => c.key !== 'all' && c.key !== 'flight');
                
                nonFlightCategories.forEach(c => {
                    if (breakdown[c.key]) {
                        breakdown[c.key].name = getCategoryName(c.key);
                        breakdown[c.key].color = getCategoryColorCode(c.key);
                    }
                });
                
                // 3. Calculate total non-flight TWD and percentage
                const totalNonFlightTWD = Object.values(breakdown).reduce((sum, item) => sum + item.amount, 0);

                // 4. Calculate percentage
                nonFlightCategories.forEach(c => {
                    if (breakdown[c.key]) {
                        const amount = breakdown[c.key].amount;
                        breakdown[c.key].percentage = totalNonFlightTWD > 0 ? Math.round((amount / totalNonFlightTWD) * 100) : 0;
                    } else {
                        // Ensure all possible categories are represented, even if amount is 0
                        breakdown[c.key] = {
                            name: getCategoryName(c.key),
                            amount: 0,
                            percentage: 0,
                            color: getCategoryColorCode(c.key)
                        };
                    }
                });
                
                // Sort by amount descending
                return Object.fromEntries(
                    Object.entries(breakdown)
                        .sort(([, a], [, b]) => b.amount - a.amount)
                );
            });
            
            // Computed property for Pie Chart CSS Background
            const pieChartBackground = computed(() => {
                const breakdown = expenseBreakdownTWD.value;
                const entries = Object.values(breakdown).filter(item => item.percentage > 0);
                
                // ã€ä¿®å¾©ï¼šç„¡è³‡æ–™æ™‚è¿”å›å®‰å…¨å€¼ã€‘
                if (entries.length === 0) {
                    return '#E2E8F0'; // Default background when no data
                }
                
                let currentDegree = 0;
                const segments = entries.map(item => {
                    const color = item.color;
                    const endDegree = currentDegree + (item.percentage / 100) * 360;
                    const segment = `${color} ${currentDegree}deg ${endDegree}deg`;
                    currentDegree = endDegree;
                    return segment;
                });
                
                // Add default grey background if the sum of percentages is less than 100 
                if (currentDegree < 360) {
                    segments.push(`#E2E8F0 ${currentDegree}deg 360deg`);
                }

                return segments.join(', ');
            });


            // Flight Info Extraction
            const flightInfo = computed(() => {
                const dep = itinerary.value.find(i => i.isFlight && i.type === 'departure');
                const ret = itinerary.value.find(i => i.isFlight && i.type === 'return');
                
                const defaultDep = { flightNo: 'BR180', depAirport: 'TPE', arrAirport: 'PUS', depTime: '14:25', terminal: 'T2', gate: 'TBD', boardingTime: '13:55' };
                const defaultRet = { flightNo: 'BR163', depAirport: 'PUS', arrAirport: 'TPE', depTime: '18:55', terminal: 'Intl', gate: 'TBD', boardingTime: '18:25' };

                return {
                    departure: dep || defaultDep,
                    return: ret || defaultRet
                };
            });

            // Hotel Info Extraction
            const hotelInfo = computed(() => {
                return {
                    name: 'é‡œå±±äºé›²æ¨¹é£¯åº— (Hotel Aventree Busan)',
                    address: 'é‡œå±±å»£åŸŸå¸‚ä¸­å€å—æµ¦è¡— 25 / ë¶€ì‚° ì¤‘êµ¬ ë‚¨í¬ê¸¸ 25', 
                };
            });


            // --- Methods ---
            
            // Utility Methods
            const getDayInfo = (dayIndex) => tripDates[dayIndex] || { date: `Day ${dayIndex}`, day: '', fullDay: `Day ${dayIndex}` };
            
            const getCategoryName = (key) => filterCategories.find(c => c.key === key)?.name || 'æœªçŸ¥';
            const getCategoryColor = (key) => filterCategories.find(c => c.key === key)?.color || 'text-text/50';
            const getCategoryColorCode = (key) => filterCategories.find(c => c.key === key)?.colorCode || '#E2E8F0';

            const openModal = (item) => {
                if (item) {
                    isEditMode.value = true;
                    // Prevent editing flight items 
                    if (item.isFlight) return alert('èˆªç­è³‡è¨Šè«‹ç›´æ¥åœ¨ã€Œæ©Ÿç¥¨/ä½å®¿ã€é é¢ä¸­æª¢è¦–ã€‚'); 

                    modalForm.value = { ...item };
                } else {
                    isEditMode.value = false;
                    modalForm.value = { id: Date.now(), time: '12:00', title: '', location: '', desc: '', category: 'sightseeing' };
                }
                showModal.value = true;
            };

            const saveItem = () => {
                if (!modalForm.value.title || !modalForm.value.category) return;
                const newItem = { 
                    ...modalForm.value, 
                    day: activeDay.value, 
                    location: modalForm.value.location || modalForm.value.title, 
                    isFlight: false 
                };

                if (isEditMode.value) {
                    const index = itinerary.value.findIndex(i => i.id === modalForm.value.id);
                    if (index !== -1) itinerary.value[index] = newItem;
                } else {
                    itinerary.value.push(newItem);
                }
                showModal.value = false;
            };

            const deleteItem = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) itinerary.value = itinerary.value.filter(item => item.id !== id);
            };

            // Expense Methods
            const addExpense = () => {
                const amount = Number(newExpense.value.amount);
                // ã€ä¿®å¾©ï¼šç¢ºä¿é‡‘é¡æ˜¯æœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0ã€‘
                if (!newExpense.value.item || isNaN(amount) || amount <= 0 || !newExpense.value.category) return;
                
                expenses.value.unshift({
                    date: newExpense.value.date || new Date().toISOString().split('T')[0],
                    item: newExpense.value.item,
                    amount: amount, 
                    category: newExpense.value.category
                });
                newExpense.value.item = '';
                newExpense.value.amount = null; // ä¿æŒç‚º null è®“ disabled å±¬æ€§æ­£å¸¸é‹ä½œ
            };

            const removeExpense = (index) => {
                if(confirm('åˆªé™¤é€™ç­†å¸³ç›®ï¼Ÿ')) expenses.value.splice(index, 1);
            };

            // Checklist Methods (Luggage & Must-Buy)
            const addLuggage = () => {
                if(!newLuggageItem.value) return;
                luggageList.value.push({ text: newLuggageItem.value, checked: false });
                newLuggageItem.value = '';
            };
            const removeLuggage = (index) => {
                luggageList.value.splice(index, 1);
            };
            const addMustBuy = () => {
                if(!newMustBuyItem.value) return;
                mustBuyList.value.push({ text: newMustBuyItem.value, checked: false });
                newMustBuyItem.value = '';
            };
            const removeMustBuy = (index) => {
                mustBuyList.value.splice(index, 1);
            };

            // Map Methods
            const searchNaverMap = () => {
                const q = mapQuery.value || 'Busan';
                window.open(`https://map.naver.com/p/search/${encodeURIComponent(q)}`, '_blank');
            };
            const searchGoogleMap = () => {
                const q = mapQuery.value || 'Busan';
                // Using a safe, general search URL for Google Maps
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(q)}`, '_blank');
            };
            const getNaverMapLink = (query) => `https://map.naver.com/p/search/${encodeURIComponent(query)}`;
            
            const formatNumber = (num) => {
                if (num === null || num === undefined) return '0';
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            };

            // Weather Icon Mapping (Simple)
            const getWeatherIcon = (code) => {
                if (code === 0) return 'â˜€ï¸'; 
                if (code === 1) return 'ğŸŒ¥ï¸'; 
                if (code <= 3) return 'â˜ï¸'; 
                if (code <= 67) return 'ğŸŒ§ï¸'; 
                return 'ğŸŒ¥ï¸'; 
            };

            return {
                currentTab, activeDay, currentTabName, currentTabIcon, activeCategory,
                showModal, isEditMode, modalForm,
                itinerary, expenses, exchangeRate, filteredItineraryByCat,
                totalExpenseTWD, newExpense, mapQuery,
                luggageList, newLuggageItem, mustBuyList, newMustBuyItem,
                flightInfo, hotelInfo, emergencyContacts, simulatedWeather, 
                calculatedTWD, calcKRW, expenseBreakdownTWD,
                desktopTabs, mobileTabs, filterCategories,
                pieChartBackground, // Expose for CSS binding
                openModal, saveItem, deleteItem, addExpense, removeExpense,
                addLuggage, removeLuggage, addMustBuy, removeMustBuy,
                formatNumber, searchNaverMap, searchGoogleMap, getNaverMapLink, getWeatherIcon, getDayInfo,
                getCategoryName, getCategoryColor, getCategoryColorCode
            };
        }
    }).mount('#app');
</script>
</body>
</html>
