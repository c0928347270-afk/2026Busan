<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busan Trip 2026 ğŸ’–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;500&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        macaron: {
                            pink: '#FFC8DD',
                            blue: '#A2D2FF',
                            yellow: '#FDFD96',
                            green: '#BDE0FE',
                            mint: '#C1E1C1',
                            purple: '#CDB4DB',
                            dark: '#555555'
                        }
                    },
                    fontFamily: {
                        cute: ['"Kiwi Maru"', '"Nunito"', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Kiwi Maru', 'Nunito', sans-serif;
            background-color: #FFF9FA;
            color: #555;
            -webkit-tap-highlight-color: transparent;
        }
        
        .cute-card {
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.05);
            border: 2px solid #FFF0F5;
        }

        .btn-press {
            transition: all 0.1s;
        }
        .btn-press:active {
            transform: scale(0.95);
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-active {
            color: #FF6B6B;
            transform: scale(1.1);
        }
        
        .flight-gradient {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border-color: #bae6fd;
        }

        .calc-input {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: right;
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
        }

        /* Checkbox Custom Style */
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.2em;
            height: 1.2em;
            border: 2px solid #CDB4DB;
            border-radius: 0.35em;
            display: grid;
            place-content: center;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #CDB4DB;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-700">

<div id="app" class="flex flex-col h-full">

    <header class="pt-10 pb-4 px-6 bg-macaron-pink rounded-b-[30px] shadow-sm z-10 flex justify-between items-center relative overflow-hidden">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 tracking-wide">
                é‡œå±±è¡Œ 2026 ğŸ‡°ğŸ‡·
            </h1>
            <p class="text-xs text-gray-700 font-bold mt-1 opacity-70">Jan 21 - Jan 25</p>
        </div>
        </header>

    <main class="flex-1 overflow-y-auto p-5 pb-28 space-y-5">
        
        <div v-if="currentTab === 'itinerary'" class="space-y-4">
            <div class="flex space-x-3 overflow-x-auto pb-2 no-scrollbar px-1">
                <button v-for="i in 5" :key="i" 
                    @click="activeDay = i"
                    :class="activeDay === i ? 'bg-macaron-blue text-white ring-2 ring-macaron-blue ring-offset-2' : 'bg-white text-gray-400 border border-gray-100'"
                    class="flex-shrink-0 w-14 h-14 rounded-2xl flex flex-col items-center justify-center shadow-sm transition-all duration-300">
                    <span class="text-[10px] uppercase font-bold">Day</span>
                    <span class="text-lg font-black leading-none">{{ i }}</span>
                </button>
            </div>

            <div class="space-y-4">
                <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
                    <p>é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢è¡Œç¨‹ âœ¨</p>
                </div>

                <div v-for="item in filteredItinerary" :key="item.id" 
                    class="cute-card p-4 flex gap-3 relative group"
                    :class="{'flight-gradient': item.isFlight}">
                    
                    <div class="flex flex-col items-center min-w-[60px]">
                        <span class="bg-macaron-yellow px-2 py-1 rounded-lg text-xs font-bold text-gray-700 shadow-sm border border-yellow-100 font-mono">
                            {{ item.time }}
                        </span>
                        <div class="h-full w-0.5 bg-gray-200 my-2 border-l-2 border-dotted"></div>
                    </div>

                    <div class="flex-1 pb-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-[16px] text-gray-800 leading-tight pr-6">{{ item.title }}</h3>
                            <div class="flex gap-2">
                                <button @click="openModal(item)" class="text-gray-400 hover:text-blue-500 btn-press">
                                    <i class="ph ph-pencil-simple text-lg"></i>
                                </button>
                                <button v-if="!item.isFlight" @click="deleteItem(item.id)" class="text-gray-400 hover:text-red-400 btn-press">
                                    <i class="ph ph-trash text-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-1 flex items-center text-xs text-gray-500 font-medium">
                            <i v-if="item.isFlight" class="ph ph-airplane-tilt mr-1 text-blue-400"></i>
                            <i v-else class="ph ph-map-pin mr-1 text-gray-400"></i>
                            <span class="truncate">{{ item.location }}</span>
                        </div>

                        <p v-if="item.desc" class="text-xs text-gray-600 mt-2 bg-white/60 p-2 rounded-lg inline-block border border-gray-100 w-full whitespace-pre-wrap">
                           {{ item.desc }}
                        </p>

                        <a v-if="!item.isFlight" :href="getNaverMapLink(item.location)" target="_blank" 
                           class="mt-3 inline-flex items-center text-[10px] font-bold text-gray-700 bg-macaron-mint px-3 py-1.5 rounded-xl shadow-sm hover:bg-green-300 transition-colors">
                            <i class="ph ph-navigation-arrow mr-1"></i> Naver Map
                        </a>
                    </div>
                </div>
            </div>
            
            <button @click="openModal(null)" class="fixed bottom-24 right-5 bg-gray-800 text-white w-14 h-14 rounded-2xl shadow-xl flex items-center justify-center text-2xl z-20 hover:scale-105 transition-transform btn-press border-2 border-white">
                <i class="ph ph-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'money'" class="space-y-6">
            <div>
                <div class="flex justify-between items-end mb-2 px-1">
                    <h3 class="font-bold text-gray-700"><i class="ph ph-calculator text-macaron-purple"></i> åŒ¯ç‡è¨ˆç®—æ©Ÿ</h3>
                    <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-lg border border-gray-200">
                        <span class="text-[10px] text-gray-400">åŒ¯ç‡</span>
                        <input v-model.number="exchangeRate" type="number" class="w-12 text-right font-bold text-sm outline-none text-blue-500">
                    </div>
                </div>
                
                <div class="cute-card p-4 bg-gradient-to-r from-gray-50 to-white">
                    <div class="flex items-center border-b border-gray-200 pb-2 mb-2">
                        <span class="text-gray-400 font-bold w-12">KRW</span>
                        <input v-model.number="calcKRW" type="number" placeholder="0" class="calc-input text-gray-800">
                    </div>
                    <div class="flex items-center pt-2">
                        <span class="text-gray-400 font-bold w-12">TWD</span>
                        <div class="w-full text-right text-2xl font-bold text-macaron-purple">
                            {{ formatNumber(Math.round((calcKRW || 0) / exchangeRate)) }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-end px-1 border-t border-gray-200 pt-6">
                    <h3 class="font-bold text-gray-700"><i class="ph ph-receipt text-macaron-purple"></i> æ”¯å‡ºè¨˜å¸³</h3>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-400">ç¸½æ”¯å‡º</p>
                        <p class="font-bold text-lg text-blue-500">NT$ {{ formatNumber(totalExpenseTWD) }}</p>
                    </div>
                </div>

                <div class="cute-card p-3 flex flex-col gap-2 bg-gray-50 border-dashed">
                    <div class="flex gap-2">
                        <input type="date" v-model="newExpense.date" class="bg-white p-2 rounded-xl text-xs outline-none border w-1/3 text-center">
                        <input v-model="newExpense.item" placeholder="å“é …" class="bg-white p-2 rounded-xl text-xs outline-none border flex-1">
                    </div>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input v-model.number="newExpense.amount" type="number" placeholder="éŸ“å¹£é‡‘é¡" class="w-full bg-white p-2 pl-6 rounded-xl text-sm outline-none border">
                            <span class="absolute left-2 top-2.5 text-xs text-gray-400">â‚©</span>
                        </div>
                        <button @click="addExpense" class="bg-macaron-purple text-white px-4 rounded-xl font-bold text-xs shadow-sm btn-press whitespace-nowrap">æ–°å¢</button>
                    </div>
                </div>

                <div class="space-y-2 pb-8">
                    <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-gray-800">{{ exp.item }}</span>
                            <span class="text-[10px] text-gray-400">{{ exp.date.slice(5) }}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <p class="font-bold text-gray-400 text-xs">â‚©{{ formatNumber(exp.amount) }}</p>
                                <p class="text-sm font-bold text-blue-500">NT$ {{ formatNumber(Math.round(exp.amount / exchangeRate)) }}</p>
                            </div>
                            <button @click="removeExpense(index)" class="text-gray-300 hover:text-red-400 p-1"><i class="ph ph-x-circle"></i></button>
                        </div>
                    </div>
                    <div v-if="expenses.length === 0" class="text-center text-xs text-gray-300 py-4">
                        é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„å–”
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'hotel'" class="space-y-5 h-full flex flex-col">
            
            <div class="cute-card p-5 bg-white shadow-md relative overflow-hidden flex-shrink-0">
                <div class="absolute top-0 left-0 w-full h-2 bg-macaron-purple"></div>
                <h2 class="text-xl font-bold text-gray-800 mb-1">Aventree Hotel Busan</h2>
                <p class="text-xs text-gray-500 mb-4 font-mono select-all">6 Gwangbok-ro 39beon-gil</p>
                
                <div class="flex gap-2 mb-4">
                    <a href="https://map.naver.com/p/search/Aventree%20Hotel%20Busan" target="_blank" class="flex-1 bg-[#03C75A] text-white py-2.5 rounded-xl font-bold text-sm text-center shadow-sm btn-press">
                        <i class="ph ph-navigation-arrow"></i> Naver å°èˆª
                    </a>
                    <a href="https://www.google.com/maps/search/?api=1&query=Aventree+Hotel+Busan" target="_blank" class="flex-1 bg-blue-50 text-blue-500 border border-blue-100 py-2.5 rounded-xl font-bold text-sm text-center shadow-sm btn-press">
                        Google åœ°åœ–
                    </a>
                </div>

                <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">è¨‚æˆ¿ç·¨è™Ÿ (Booking No.)</label>
                    <div class="flex items-center gap-2">
                        <i class="ph ph-hash text-gray-400"></i>
                        <input v-model="hotelBookingId" type="text" placeholder="é»æ“Šè¼¸å…¥..." class="bg-transparent w-full outline-none font-mono font-bold text-gray-700 placeholder-gray-300">
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center px-1 mb-2">
                    <h3 class="font-bold text-gray-700"><i class="ph ph-suitcase-rolling text-macaron-purple"></i> å‡ºåœ‹è¡Œææ¸…å–®</h3>
                    <span class="text-xs text-gray-400">{{ luggageList.filter(i => i.checked).length }} / {{ luggageList.length }}</span>
                </div>
                
                <div class="cute-card flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col">
                    <div class="flex gap-2 mb-4">
                         <input v-model="newLuggageItem" @keyup.enter="addLuggage" type="text" placeholder="æ–°å¢ç‰©å“..." class="flex-1 bg-white p-2.5 rounded-xl text-sm outline-none border focus:border-macaron-purple">
                         <button @click="addLuggage" class="bg-macaron-purple text-white w-10 h-10 rounded-xl flex items-center justify-center btn-press"><i class="ph ph-plus-bold"></i></button>
                    </div>

                    <div class="space-y-2">
                        <div v-for="(item, index) in luggageList" :key="index" class="flex items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                            <input type="checkbox" v-model="item.checked" class="custom-checkbox text-macaron-purple flex-shrink-0 cursor-pointer">
                            <span class="ml-3 flex-1 text-sm font-bold text-gray-700" :class="{'line-through text-gray-300': item.checked}">{{ item.text }}</span>
                            <button @click="removeLuggage(index)" class="text-gray-200 hover:text-red-400 px-2"><i class="ph ph-trash"></i></button>
                        </div>
                        <div v-if="luggageList.length === 0" class="text-center text-xs text-gray-300 mt-4">æ¸…å–®æ˜¯ç©ºçš„</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'map'" class="h-full flex flex-col">
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-green-50">
                <input v-model="mapQuery" @keyup.enter="searchNaverMap" type="text" placeholder="è¼¸å…¥åœ°é»æœå°‹ (ä¾‹å¦‚ï¼šæµ·é›²å°)" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm outline-none font-bold mb-3 focus:bg-white focus:ring-2 focus:ring-green-100 transition">
                
                <div class="flex gap-2">
                    <button @click="searchNaverMap" class="flex-1 bg-[#03C75A] text-white py-3 rounded-xl font-bold text-sm shadow-md btn-press flex items-center justify-center gap-2">
                        <i class="ph ph-navigation-arrow"></i> Naver Map
                    </button>
                    <button @click="searchGoogleMap" class="flex-1 bg-blue-50 text-blue-500 border border-blue-100 py-3 rounded-xl font-bold text-sm shadow-sm btn-press flex items-center justify-center gap-2">
                        <i class="ph ph-map-pin"></i> Google Map
                    </button>
                </div>
            </div>
            
            <div class="flex-1 rounded-3xl overflow-hidden shadow-sm border-4 border-white relative bg-gray-100">
                <iframe width="100%" height="100%" style="border:0" loading="lazy" src="http://googleusercontent.com/maps.google.com/8"></iframe>
                <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-lg text-xs font-bold text-gray-500 shadow-sm">
                    åƒ…ä¾›æ¦‚è¦½ï¼Œå°èˆªè«‹ä½¿ç”¨ä¸Šæ–¹æŒ‰éˆ•
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'weather'" class="space-y-4">
             <div class="cute-card p-6 text-center bg-gradient-to-b from-sky-50 to-white">
                <h2 class="text-lg font-bold text-gray-600 uppercase tracking-widest mb-2">Busan</h2>
                <div v-if="weatherLoading" class="py-8 text-gray-400 text-sm">æ­£åœ¨æŠ“å–æ°£è±¡è³‡æ–™...</div>
                <div v-else>
                    <div class="text-6xl my-2">{{ getWeatherIcon(currentWeather.code) }}</div>
                    <p class="text-5xl font-black text-gray-800">{{ currentWeather.temp }}Â°</p>
                    <div class="mt-4 flex justify-center gap-4 text-xs font-bold text-gray-500">
                        <span class="bg-white px-3 py-1 rounded-full shadow-sm">é™é›¨æ©Ÿç‡ {{ currentWeather.rain }}%</span>
                        <span class="bg-white px-3 py-1 rounded-full shadow-sm">{{ currentWeather.desc }}</span>
                    </div>
                </div>
            </div>
            
            <div class="cute-card p-4">
                <h3 class="font-bold mb-3 text-xs text-gray-400 uppercase ml-1">æœªä¾† 5 å¤©é å ±</h3>
                <div v-if="!weatherLoading" class="space-y-1">
                    <div v-for="(day, index) in forecast" :key="index" class="flex items-center justify-between py-3 border-b border-gray-50 last:border-0 px-2 hover:bg-gray-50 rounded-lg transition">
                        <div class="w-20">
                            <p class="font-bold text-gray-700 text-sm">{{ day.dateStr }}</p>
                        </div>
                        <div class="flex-1 text-center text-xl">
                            {{ getWeatherIcon(day.code) }}
                        </div>
                        <div class="w-24 text-right flex gap-2 justify-end text-sm">
                            <span class="text-gray-400">{{ day.min }}Â°</span>
                            <span class="text-gray-300">/</span>
                            <span class="font-bold text-gray-800">{{ day.max }}Â°</span>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-5 text-gray-300 text-xs">è¼‰å…¥ä¸­...</div>
            </div>

            <a href="https://www.google.com/search?q=é‡œå±±å¤©æ°£" target="_blank" class="block text-center text-xs text-blue-400 font-bold bg-white p-3 rounded-xl shadow-sm border border-blue-50">
                å‰å¾€ Google æŸ¥çœ‹æ›´å¤šè©³æƒ…
            </a>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full pb-safe pt-2 px-2 flex justify-between items-center bg-white/95 backdrop-blur-md rounded-t-[30px] shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-30 border-t border-gray-100">
        <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-macaron-pink tab-active' : 'text-gray-400'" class="flex flex-col items-center p-2 flex-1 transition-all">
            <i class="ph ph-notebook text-2xl" :weight="currentTab === 'itinerary' ? 'fill' : 'regular'"></i>
            <span class="text-[10px] font-bold mt-1">è¡Œç¨‹</span>
        </button>
        <button @click="currentTab = 'money'" :class="currentTab === 'money' ? 'text-macaron-blue tab-active' : 'text-gray-400'" class="flex flex-col items-center p-2 flex-1 transition-all">
            <i class="ph ph-currency-krw text-2xl" :weight="currentTab === 'money' ? 'fill' : 'regular'"></i>
            <span class="text-[10px] font-bold mt-1">åŒ¯ç‡/è¨˜å¸³</span>
        </button>
        <button @click="currentTab = 'hotel'" :class="currentTab === 'hotel' ? 'text-macaron-purple tab-active' : 'text-gray-400'" class="flex flex-col items-center p-2 flex-1 transition-all">
            <i class="ph ph-suitcase-rolling text-2xl" :weight="currentTab === 'hotel' ? 'fill' : 'regular'"></i>
            <span class="text-[10px] font-bold mt-1">ä½å®¿/è¡Œæ</span>
        </button>
        <button @click="currentTab = 'map'" :class="currentTab === 'map' ? 'text-macaron-mint tab-active' : 'text-gray-400'" class="flex flex-col items-center p-2 flex-1 transition-all">
            <i class="ph ph-map-trifold text-2xl" :weight="currentTab === 'map' ? 'fill' : 'regular'"></i>
            <span class="text-[10px] font-bold mt-1">åœ°åœ–</span>
        </button>
        <button @click="currentTab = 'weather'" :class="currentTab === 'weather' ? 'text-yellow-400 tab-active' : 'text-gray-400'" class="flex flex-col items-center p-2 flex-1 transition-all">
            <i class="ph ph-sun-horizon text-2xl" :weight="currentTab === 'weather' ? 'fill' : 'regular'"></i>
            <span class="text-[10px] font-bold mt-1">å¤©æ°£</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-100 transition-transform">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-700">
                    {{ isEditMode ? 'ç·¨è¼¯è¡Œç¨‹ âœï¸' : 'æ–°å¢è¡Œç¨‹ âœ¨' }}
                </h3>
                <button @click="showModal = false" class="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-macaron-purple font-bold ml-1">æ™‚é–“</label>
                    <input v-model="modalForm.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl mt-1 outline-none border focus:border-macaron-purple">
                </div>
                <div>
                    <label class="text-xs text-macaron-purple font-bold ml-1">æ¨™é¡Œ</label>
                    <input v-model="modalForm.title" type="text" placeholder="è¡Œç¨‹åç¨±" class="w-full bg-gray-50 p-3 rounded-xl mt-1 outline-none border focus:border-macaron-purple">
                </div>
                <div>
                    <label class="text-xs text-macaron-purple font-bold ml-1">åœ°é» (åœ°åœ–æœå°‹ç”¨)</label>
                    <input v-model="modalForm.location" type="text" placeholder="è¼¸å…¥é—œéµå­—" class="w-full bg-gray-50 p-3 rounded-xl mt-1 outline-none border focus:border-macaron-purple">
                </div>
                <div>
                    <label class="text-xs text-macaron-purple font-bold ml-1">å‚™è¨» (ç‡Ÿæ¥­æ™‚é–“/è³‡è¨Š)</label>
                    <textarea v-model="modalForm.desc" rows="3" placeholder="ä¾‹å¦‚ï¼šç‡Ÿæ¥­æ™‚é–“ 10:00-22:00" class="w-full bg-gray-50 p-3 rounded-xl mt-1 outline-none border focus:border-macaron-purple resize-none"></textarea>
                </div>
            </div>
            <button @click="saveItem" class="w-full mt-6 py-3.5 bg-gray-800 text-white font-bold rounded-xl shadow-lg btn-press">
                å„²å­˜
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // --- State ---
            const currentTab = ref('itinerary');
            const activeDay = ref(1);
            const showModal = ref(false);
            const isEditMode = ref(false);
            const mapQuery = ref('');
            
            // Hotel & Luggage
            const hotelBookingId = ref('');
            const luggageList = ref([]);
            const newLuggageItem = ref('');

            // Calculator
            const calcKRW = ref('');
            const exchangeRate = ref(41.5); 
            
            // Expenses
            const expenses = ref([]);
            const newExpense = ref({ date: '', item: '', amount: '' });

            // Modal Form
            const modalForm = ref({ id: null, time: '', title: '', location: '', desc: '' });

            // Default Data
            const defaultLuggage = [
                { text: 'è­·ç…§ / ç°½è­‰', checked: false },
                { text: 'éŸ“å¹£ç¾é‡‘ / ä¿¡ç”¨å¡', checked: false },
                { text: 'WOWPASS å¡', checked: false },
                { text: 'è½‰æ¥é ­ (éŸ“åœ‹åœ“å­”)', checked: false },
                { text: 'è¡Œå‹•é›»æº / å……é›»ç·š', checked: false },
                { text: 'ç‰™åˆ·ç‰™è† (éŸ“åœ‹ç’°ä¿ä¸æä¾›)', checked: false },
                { text: 'å€‹äººå¸¸å‚™è—¥å“', checked: false },
                { text: 'ä¿æš–è¡£ç‰© / åœå·¾', checked: false },
                { text: 'ç¶²å¡ / eSim', checked: false }
            ];

            const defaultItinerary = [
                // Day 1
                { id: 101, day: 1, time: '14:25', title: 'å»ç¨‹: é•·æ¦®èˆªç©º BR164', location: 'Taoyuan Intl Airport T2', desc: 'ç¶“æ¿Ÿè‰™ V | 17:40 æŠµé”é‡œå±±', isFlight: true },
                { id: 102, day: 1, time: '19:00', title: 'é£¯åº— Check-in', location: 'Aventree Hotel Busan', desc: 'åœ°å€ï¼š6 Gwangbok-ro 39beon-gil' },
                { id: 103, day: 1, time: '20:00', title: 'æ‰å˜å…¶å¸‚å ´ / BIFFå»£å ´', location: 'Jagalchi Market', desc: 'æ™šé¤ã€é€›å¤œå¸‚' },
                // Day 2
                { id: 201, day: 2, time: '09:00', title: 'æµ·é›²å°å‚³çµ±å¸‚å ´', location: 'Haeundae Traditional Market', desc: 'æ—©é¤ï¼šåˆ€å‰Šéºµã€é£¯æ²' },
                { id: 202, day: 2, time: '10:20', title: 'æµ·æ±é¾å®®å¯º', location: 'Haedong Yonggungsa', desc: 'æµ·é‚Šå¯ºå»Ÿ' },
                { id: 203, day: 2, time: '11:40', title: 'æ¨‚å¤© Outlet', location: 'Lotte Premium Outlets Dongbusan', desc: 'åˆé¤ + è³¼ç‰©' },
                { id: 204, day: 2, time: '15:00', title: 'SPA LAND æ±—è’¸å¹•', location: 'Spa Land Centum City', desc: 'æ–°ä¸–ç•Œç™¾è²¨ B1' },
                // Day 3
                { id: 301, day: 3, time: '09:00', title: 'KKdayä¸€æ—¥éŠé›†åˆ', location: 'Busan Station', desc: 'å‰å¾€æ…¶å·' },
                { id: 302, day: 3, time: '10:30', title: 'å¤©ç©ºè† å›Šåˆ—è»Š', location: 'Haeundae Blueline Park', desc: 'è—ç·šå…¬åœ’' },
                { id: 303, day: 3, time: '15:00', title: 'ä½›åœ‹å¯º', location: 'Bulguksa', desc: 'æ…¶å·ä¸–ç•Œéºç”¢' },
                { id: 304, day: 3, time: '19:00', title: 'æ±å®®èˆ‡æœˆæ± ', location: 'Donggung Palace and Wolji Pond', desc: 'å¤œæ™¯' },
                // Day 4
                { id: 401, day: 4, time: '09:30', title: 'æ¾å³¶å¤©ç©ºæ­¥é“', location: 'Songdo Cloud Trails', desc: 'æµ·ä¸Šæ­¥é“' },
                { id: 402, day: 4, time: '10:20', title: 'æ¾å³¶æµ·ä¸Šçºœè»Š', location: 'Songdo Marine Cable Car', desc: 'æ°´æ™¶è»Šå»‚' },
                { id: 403, day: 4, time: '14:00', title: 'å½±å³¶å¤§æ©‹é–‹æ©‹', location: 'Yeongdo Bridge', desc: 'æ¨‚å¤©ç™¾è²¨é ‚æ¨“è§€çœ‹' },
                { id: 404, day: 4, time: '15:00', title: 'ç™½æ·ºç˜æ–‡åŒ–æ‘', location: 'Huinnyeoul Culture Village', desc: 'æµ·æ™¯å’–å•¡å»³' },
                // Day 5
                { id: 501, day: 5, time: '09:00', title: 'ç”˜å·æ´æ–‡åŒ–æ‘', location: 'Gamcheon Culture Village', desc: 'å°ç‹å­æ‹ç…§' },
                { id: 502, day: 5, time: '11:30', title: 'è¿”å›å—æµ¦æ´', location: 'Nampo Station', desc: 'æœ€å¾Œæ¡è²·ã€æ‹¿è¡Œæ' },
                { id: 503, day: 5, time: '15:30', title: 'å‰å¾€é‡‘æµ·æ©Ÿå ´', location: 'Gimhae International Airport', desc: 'è¾¦ç†é€€ç¨…ã€ç™»æ©Ÿ' },
                { id: 504, day: 5, time: '18:55', title: 'å›ç¨‹: é•·æ¦®èˆªç©º BR163', location: 'Gimhae International Airport', desc: 'ç¶“æ¿Ÿè‰™ V | 20:25 æŠµé”æ¡ƒåœ’', isFlight: true },
            ];

            const itinerary = ref([]);
            
            // Weather
            const weatherLoading = ref(true);
            const currentWeather = ref({ temp: '--', desc: '--', rain: 0, code: 0 });
            const forecast = ref([]);

            // --- Lifecycle ---
            onMounted(() => {
                newExpense.value.date = new Date().toISOString().split('T')[0];

                const savedItinerary = localStorage.getItem('busan_2026_v3_itinerary');
                const savedExpenses = localStorage.getItem('busan_2026_v3_expenses');
                const savedRate = localStorage.getItem('busan_2026_rate');
                const savedBooking = localStorage.getItem('busan_2026_booking');
                const savedLuggage = localStorage.getItem('busan_2026_luggage');
                
                itinerary.value = savedItinerary ? JSON.parse(savedItinerary) : defaultItinerary;
                if (savedExpenses) expenses.value = JSON.parse(savedExpenses);
                if (savedRate) exchangeRate.value = parseFloat(savedRate);
                if (savedBooking) hotelBookingId.value = savedBooking;
                luggageList.value = savedLuggage ? JSON.parse(savedLuggage) : defaultLuggage;

                fetchWeather();
            });

            // --- Watchers for Auto-Save ---
            watch([itinerary, expenses, exchangeRate, hotelBookingId, luggageList], () => {
                localStorage.setItem('busan_2026_v3_itinerary', JSON.stringify(itinerary.value));
                localStorage.setItem('busan_2026_v3_expenses', JSON.stringify(expenses.value));
                localStorage.setItem('busan_2026_rate', exchangeRate.value);
                localStorage.setItem('busan_2026_booking', hotelBookingId.value);
                localStorage.setItem('busan_2026_luggage', JSON.stringify(luggageList.value));
            }, { deep: true });

            // --- Computed ---
            const filteredItinerary = computed(() => {
                return itinerary.value
                    .filter(item => item.day === activeDay.value)
                    .sort((a, b) => a.time.localeCompare(b.time));
            });

            const totalExpenseTWD = computed(() => {
                const totalKRW = expenses.value.reduce((sum, item) => sum + item.amount, 0);
                return Math.round(totalKRW / exchangeRate.value);
            });

            // --- Methods ---
            const openModal = (item) => {
                if (item) {
                    isEditMode.value = true;
                    modalForm.value = { ...item };
                } else {
                    isEditMode.value = false;
                    modalForm.value = { id: Date.now(), time: '12:00', title: '', location: '', desc: '' };
                }
                showModal.value = true;
            };

            const saveItem = () => {
                if (!modalForm.value.title) return;
                if (isEditMode.value) {
                    const index = itinerary.value.findIndex(i => i.id === modalForm.value.id);
                    if (index !== -1) itinerary.value[index] = { ...modalForm.value };
                } else {
                    itinerary.value.push({ ...modalForm.value, day: activeDay.value, location: modalForm.value.location || modalForm.value.title });
                }
                showModal.value = false;
            };

            const deleteItem = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) itinerary.value = itinerary.value.filter(item => item.id !== id);
            };

            const addExpense = () => {
                if (!newExpense.value.item || !newExpense.value.amount) return;
                expenses.value.unshift({
                    date: newExpense.value.date || new Date().toISOString().split('T')[0],
                    item: newExpense.value.item,
                    amount: newExpense.value.amount
                });
                newExpense.value.item = '';
                newExpense.value.amount = '';
            };

            const removeExpense = (index) => {
                if(confirm('åˆªé™¤é€™ç­†å¸³ç›®ï¼Ÿ')) expenses.value.splice(index, 1);
            };

            // Luggage Methods
            const addLuggage = () => {
                if(!newLuggageItem.value) return;
                luggageList.value.push({ text: newLuggageItem.value, checked: false });
                newLuggageItem.value = '';
            };
            const removeLuggage = (index) => {
                luggageList.value.splice(index, 1);
            };

            // Map Methods
            const searchNaverMap = () => {
                const q = mapQuery.value || 'Busan';
                window.open(`https://map.naver.com/p/search/${encodeURIComponent(q)}`, '_blank');
            };
            const searchGoogleMap = () => {
                const q = mapQuery.value || 'Busan';
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(q)}`, '_blank');
            };
            const getNaverMapLink = (query) => `https://map.naver.com/p/search/${encodeURIComponent(query)}`;
            
            const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            // Weather Fetch
            const fetchWeather = async () => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.1796&longitude=129.0756&current=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    
                    currentWeather.value = {
                        temp: Math.round(data.current.temperature_2m),
                        desc: getWeatherDesc(data.current.weather_code),
                        rain: data.current.precipitation_probability || 0,
                        code: data.current.weather_code
                    };

                    forecast.value = data.daily.time.map((date, idx) => ({
                        dateStr: new Date(date).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' }),
                        code: data.daily.weather_code[idx],
                        max: Math.round(data.daily.temperature_2m_max[idx]),
                        min: Math.round(data.daily.temperature_2m_min[idx])
                    })).slice(0, 5);

                    weatherLoading.value = false;
                } catch (e) { weatherLoading.value = false; }
            };

            const getWeatherDesc = (code) => {
                if (code === 0) return 'æ™´æœ—';
                if (code <= 3) return 'å¤šé›²';
                if (code <= 67) return 'é›¨å¤©';
                if (code <= 77) return 'é›ª';
                return 'é™°å¤©';
            };

            const getWeatherIcon = (code) => {
                if (code === 0) return 'â˜€ï¸';
                if (code <= 3) return 'â˜ï¸';
                if (code <= 67) return 'ğŸŒ§ï¸';
                return 'ğŸŒ¥ï¸';
            };

            return {
                currentTab, activeDay, showModal, isEditMode, modalForm,
                itinerary, expenses, exchangeRate, filteredItinerary,
                totalExpenseTWD, newExpense, mapQuery,
                hotelBookingId, calcKRW, luggageList, newLuggageItem,
                openModal, saveItem, deleteItem, addExpense, removeExpense,
                addLuggage, removeLuggage,
                weatherLoading, currentWeather, forecast, getWeatherIcon,
                formatNumber, searchNaverMap, searchGoogleMap, getNaverMapLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>
